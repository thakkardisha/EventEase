<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventEase - Dynamic Booking Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        .event-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .event-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        .event-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
        }
        .event-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .event-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .event-detail {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }
        .event-detail strong {
            color: #667eea;
        }
        .coupon-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }
        .coupon-item:hover {
            border-color: #4caf50;
        }
        .coupon-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .coupon-info {
            flex: 1;
        }
        .coupon-code {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }
        .coupon-discount {
            color: #4caf50;
            font-weight: 600;
            margin-top: 5px;
        }
        .coupon-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .single-use { background: #ffe0b2; color: #e65100; }
        .multi-use { background: #c8e6c9; color: #2e7d32; }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .summary-box {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #ccc;
        }
        .summary-row:last-child {
            border-bottom: none;
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
        }
        .summary-row.error-row {
            color: #f44336;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .response-box {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        @media (max-width: 768px) {
            .event-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body onload="initPage()">
    <div class="container">
        <h1>üé´ EventEase - Dynamic Booking System</h1>
        <p class="subtitle">Real-time Database Integration</p>

        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Loading data from database...</p>
        </div>

        <div id="mainContent" style="display: none;">

            <div class="section">
                <h2>üë§ Step 1: Select User</h2>
                <div class="form-group">
                    <label for="userSelect">Choose User:</label>
                    <select id="userSelect" onchange="updateSelectedUser()">
                        <option value="">-- Loading users... --</option>
                    </select>
                </div>
                <div id="userInfo" style="display: none;" class="alert alert-success"></div>
            </div>

            <div class="section">
                <h2>üé™ Step 2: Select Event</h2>
                <div id="eventsContainer">
                    <p class="loading">Loading events...</p>
                </div>
                <div id="eventInfo" style="display: none;" class="alert alert-success"></div>
            </div>

            <div class="section">
                <h2>üéüÔ∏è Step 3: Number of Tickets</h2>
                <div class="form-group">
                    <label for="ticketCount">Quantity (1-10):</label>
                    <input type="number" id="ticketCount" min="1" max="10" value="2" onchange="calculateTotal()">
                </div>
            </div>

            <div class="section">
                <h2>üí∞ Step 4: Apply Coupons (Max 2)</h2>
                <div id="couponsContainer">
                    <p class="loading">Select an event to see available coupons...</p>
                </div>
            </div>

            <div class="section">
                <h2>üìä Step 5: Booking Summary</h2>
                <div class="summary-box">
                    <div class="summary-row">
                        <span>Event:</span>
                        <span id="summaryEvent">--</span>
                    </div>
                    <div class="summary-row">
                        <span>Unit Price:</span>
                        <span id="summaryPrice">‚Çπ0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tickets:</span>
                        <span id="summaryTickets">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Base Amount:</span>
                        <span id="summaryBase">‚Çπ0.00</span>
                    </div>
                    <div class="summary-row" id="discountRow" style="color: #4caf50; display: none;">
                        <span>Total Discount:</span>
                        <span id="summaryDiscount">-‚Çπ0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Final Amount:</span>
                        <span id="summaryTotal">‚Çπ0.00</span>
                    </div>
                </div>

                <button class="btn btn-success" onclick="processBooking()">
                    üöÄ Complete Booking
                </button>
            </div>

            <div id="resultSection" class="section" style="display: none;">
                <h2>‚úÖ Booking Successful!</h2>
                <div id="bookingResult"></div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8181/EventEase/api';
        
        let allEvents = [];
        let allUsers = [];
        let allCoupons = [];
        let selectedUser = null;
        let selectedEvent = null;
        let selectedCoupons = [];

        // Initialize page
        async function initPage() {
            try {
                await Promise.all([
                    loadUsers(),
                    loadEvents(),
                    loadAllCoupons()
                ]);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loadingIndicator').innerHTML = 
                    '<div class="alert alert-error">Error loading data: ' + error.message + '</div>';
            }
        }

        // Load Users
        async function loadUsers() {
            const response = await fetch(`${API_BASE}/user/all`);
            allUsers = await response.json();
            
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- Select User --</option>';
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.userId;
                option.textContent = `${user.fullName} (@${user.username})`;
                select.appendChild(option);
            });
        }

        // Load Events
        async function loadEvents() {
            const response = await fetch(`${API_BASE}/admin/event/upcoming`);
            allEvents = await response.json();
            
            const container = document.getElementById('eventsContainer');
            if (allEvents.length === 0) {
                container.innerHTML = '<p class="alert alert-warning">No upcoming events found.</p>';
                return;
            }

            container.innerHTML = '';
            allEvents.forEach(event => {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.onclick = () => selectEvent(event.eId);
                card.id = `event-${event.eId}`;
                
                card.innerHTML = `
                    <h3>${event.eName}</h3>
                    <div class="event-details">
                        <div class="event-detail">
                            <strong>Date:</strong> ${event.eventDate}
                        </div>
                        <div class="event-detail">
                            <strong>Price:</strong> ‚Çπ${event.unitPrice}
                        </div>
                        <div class="event-detail">
                            <strong>Available:</strong> ${event.maxCapacity - event.bookedSeats} seats
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Load All Coupons
        async function loadAllCoupons() {
            const response = await fetch(`${API_BASE}/admin/coupons/active`);
            allCoupons = await response.json();
        }

        // Update Selected User
        function updateSelectedUser() {
            const userId = document.getElementById('userSelect').value;
            if (!userId) {
                selectedUser = null;
                document.getElementById('userInfo').style.display = 'none';
                return;
            }

            selectedUser = allUsers.find(u => u.userId == userId);
            const info = document.getElementById('userInfo');
            info.style.display = 'block';
            info.innerHTML = `Selected: <strong>${selectedUser.fullName}</strong> (${selectedUser.email})`;
        }

        // Select Event
        async function selectEvent(eventId) {
            // Remove previous selection
            document.querySelectorAll('.event-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection
            document.getElementById(`event-${eventId}`).classList.add('selected');
            selectedEvent = allEvents.find(e => e.eId === eventId);

            // Show event info
            const info = document.getElementById('eventInfo');
            info.style.display = 'block';
            info.innerHTML = `Selected: <strong>${selectedEvent.eName}</strong> - ‚Çπ${selectedEvent.unitPrice} per ticket`;

            // Load coupons for this event
            await loadCouponsForEvent(eventId);

            // Update summary
            calculateTotal();
        }

        // Load Coupons for Event
        async function loadCouponsForEvent(eventId) {
            try {
                // Get event-specific coupons
                const eventResponse = await fetch(`${API_BASE}/admin/coupons/event/${eventId}/valid`);
                const eventCoupons = await eventResponse.json();

                // Get general coupons (those not associated with any event)
                const generalCoupons = allCoupons.filter(coupon => {
                    return !eventCoupons.some(ec => ec.cId === coupon.cId);
                });

                // Combine both
                const availableCoupons = [...eventCoupons, ...generalCoupons];

                displayCoupons(availableCoupons);
            } catch (error) {
                console.error('Error loading coupons:', error);
                document.getElementById('couponsContainer').innerHTML = 
                    '<p class="alert alert-error">Error loading coupons</p>';
            }
        }

        // Display Coupons
        function displayCoupons(coupons) {
            const container = document.getElementById('couponsContainer');
            
            if (coupons.length === 0) {
                container.innerHTML = '<p class="alert alert-warning">No coupons available for this event.</p>';
                return;
            }

            container.innerHTML = '';
            selectedCoupons = []; // Reset selection
            
            coupons.forEach(coupon => {
                const div = document.createElement('div');
                div.className = 'coupon-item';
                
                const discountText = coupon.discountType === 'percent' 
                    ? `${coupon.discountValue}% OFF`
                    : `‚Çπ${coupon.discountValue} OFF`;

                const badge = coupon.isSingleUse 
                    ? '<span class="coupon-badge single-use">Single Use</span>'
                    : '<span class="coupon-badge multi-use">Multi Use</span>';

                div.innerHTML = `
                    <input type="checkbox" id="coupon-${coupon.cId}" 
                           onchange="toggleCoupon(${coupon.cId})" 
                           data-discount-type="${coupon.discountType}"
                           data-discount-value="${coupon.discountValue}">
                    <div class="coupon-info">
                        <div class="coupon-code">${coupon.cCode}</div>
                        <div class="coupon-discount">${discountText}</div>
                    </div>
                    ${badge}
                `;
                container.appendChild(div);
            });
        }

        // Toggle Coupon Selection
        function toggleCoupon(couponId) {
            const checkbox = document.getElementById(`coupon-${couponId}`);
            
            if (checkbox.checked) {
                // Check if already 2 coupons selected
                const checkedCount = document.querySelectorAll('#couponsContainer input[type="checkbox"]:checked').length;
                if (checkedCount > 2) {
                    checkbox.checked = false;
                    alert('Maximum 2 coupons can be applied per booking!');
                    return;
                }
                selectedCoupons.push({
                    cId: couponId,
                    type: checkbox.dataset.discountType,
                    value: parseFloat(checkbox.dataset.discountValue)
                });
            } else {
                selectedCoupons = selectedCoupons.filter(c => c.cId !== couponId);
            }

            calculateTotal();
        }

        // Calculate Total
        function calculateTotal() {
            if (!selectedEvent) return;

            const ticketCount = parseInt(document.getElementById('ticketCount').value) || 0;
            const unitPrice = parseFloat(selectedEvent.unitPrice);
            const baseAmount = unitPrice * ticketCount;

            let totalDiscount = 0;
            selectedCoupons.forEach(coupon => {
                if (coupon.type === 'percent') {
                    totalDiscount += (baseAmount * coupon.value / 100);
                } else if (coupon.type === 'fixed') {
                    totalDiscount += coupon.value;
                }
            });

            // Cap discount
            if (totalDiscount > baseAmount) totalDiscount = baseAmount;

            const finalAmount = baseAmount - totalDiscount;

            // Update summary
            document.getElementById('summaryEvent').textContent = selectedEvent.eName;
            document.getElementById('summaryPrice').textContent = `‚Çπ${unitPrice.toFixed(2)}`;
            document.getElementById('summaryTickets').textContent = ticketCount;
            document.getElementById('summaryBase').textContent = `‚Çπ${baseAmount.toFixed(2)}`;
            
            if (totalDiscount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('summaryDiscount').textContent = `-‚Çπ${totalDiscount.toFixed(2)}`;
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            document.getElementById('summaryTotal').textContent = `‚Çπ${finalAmount.toFixed(2)}`;
        }

        // Process Booking
        async function processBooking() {
            // Validation
            if (!selectedUser) {
                alert('Please select a user!');
                return;
            }
            if (!selectedEvent) {
                alert('Please select an event!');
                return;
            }

            const ticketCount = parseInt(document.getElementById('ticketCount').value);
            if (ticketCount < 1) {
                alert('Please select at least 1 ticket!');
                return;
            }

            try {
                const finalAmount = parseFloat(
                    document.getElementById('summaryTotal').textContent.replace('‚Çπ', '').replace(',', '')
                );

                // 1. CONSTRUCT THE COMPLETE BOOKING OBJECT (includes all necessary FKs for EJB)
                const bookingData = {
                    userId: { userId: selectedUser.userId },
                    eId: { eId: selectedEvent.eId }, // CRITICAL: Now including eId here
                    ticketCount: ticketCount,
                };

                if (selectedCoupons.length > 0) {
                    bookingData.couponsCollection = selectedCoupons.map(c => ({ cId: c.cId }));
                }

                // 2. EMBED THE COMPLETE BOOKING OBJECT INTO THE PAYMENT PAYLOAD
                const paymentData = {
                    bId: bookingData, // CRITICAL FIX: Full booking data is now nested
                    amount: Math.round(finalAmount),
                    transactionId: 'TXN-' + Date.now(),
                    paymentStatus: 'SUCCESS'
                };

                // 3. SEND A SINGLE REQUEST TO THE /payments ENDPOINT
                // The server-side makePayment method will handle persistence of both Payment and Booking
                const paymentResponse = await fetch(`${API_BASE}/user/bookings/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });

                if (!paymentResponse.ok) {
                    const errorText = await paymentResponse.text();
                    // Attempt to parse JSON error if available, otherwise use plain text
                    let errorMessage = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        // Check for common Payara/Jakarta error structures
                        if (errorJson.message) {
                            errorMessage = errorJson.message;
                        } else if (errorJson.exception) {
                            errorMessage = errorJson.exception;
                        }
                    } catch (e) {
                        // ignore JSON parse error, use plain text
                    }
                    throw new Error(`Booking/Payment failed (${paymentResponse.status}): ${errorMessage}`);
                }

                // The server returns the completed Payments object.
                const payment = await paymentResponse.json();
                // Extract the completed Booking entity from the nested bId field
                const booking = payment.bId; 

                // Show success
                displayBookingResult(booking, payment);

            } catch (error) {
                alert('Booking failed: ' + error.message);
                console.error('Booking error:', error);
            }
        }

        // Display Booking Result
        function displayBookingResult(booking, payment) {
            const section = document.getElementById('resultSection');
            const result = document.getElementById('bookingResult');

            result.innerHTML = `
                <div class="alert alert-success">
                    <h3>üéâ Booking Confirmed!</h3>
                    <p><strong>Booking ID:</strong> ${booking.bId}</p>
                    <p><strong>Transaction ID:</strong> ${payment.transactionId}</p>
                    <p><strong>Amount Paid:</strong> ‚Çπ${payment.amount}</p>
                    <p><strong>Tickets Generated:</strong> ${booking.ticketCount}</p>
                </div>
                <div class="response-box">
${JSON.stringify(booking, null, 2)}
                </div>
                <button class="btn btn-primary" onclick="location.reload()">
                    Create Another Booking
                </button>
            `;

            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

    </script>
</body>
</html>