<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    
    <f:metadata>
        <f:viewAction action="#{adminCDI.init}" />
    </f:metadata>


    <h:form id="crudForm">

        <!-- GLOBAL MESSAGES -->
<!--        <p:messages id="msgs" showDetail="true" autoUpdate="true" />-->

        <h2 style="margin-bottom: 12px;">CRUD Management</h2>

        <!-- ADD BUTTON -->
        <p:commandButton value="Add New Event"
                         icon="pi pi-plus"
                         styleClass="p-mb-3"
                         actionListener="#{adminCDI.prepareNew}"
                         update=":eventDialogForm"
                         oncomplete="PF('eventDialog').show()" />

        <!-- TABLE -->
        <p:dataTable id="eventTable" var="evt"
                     value="#{adminCDI.events}"
                     paginator="true" rows="8"
                     selectionMode="single"
                     selection="#{adminCDI.selected}"
                     rowKey="#{evt.eId}"
                     style="margin-top:10px">

            <p:column headerText="ID" style="width:6%">
                <h:outputText value="#{evt.eId}" />
            </p:column>

            <p:column headerText="Name">
                <h:outputText value="#{evt.eName}" />
            </p:column>

            <p:column headerText="Date">
                <h:outputText value="#{evt.eventDate}" />
            </p:column>

            <p:column headerText="Venue">
                <h:outputText value="#{evt.vId != null ? evt.vId.vName : ''}" />
            </p:column>

            <p:column headerText="Category">
                <h:outputText value="#{evt.cId != null ? evt.cId.cName : ''}" />
            </p:column>

            <p:column headerText="Price">
                <h:outputText value="#{evt.unitPrice}" />
            </p:column>

            <p:column headerText="Status">
                <h:outputText value="#{evt.status}" />
            </p:column>

            <p:column headerText="Actions" style="width:18%">

                <!-- EDIT -->
                <p:commandButton icon="pi pi-pencil"
                                 title="Edit"
                                 actionListener="#{adminCDI.prepareEdit(evt)}"
                                 update=":eventDialogForm"
                                 oncomplete="PF('eventDialog').show()"
                                 styleClass="p-button-rounded p-button-sm" />

                <!-- DELETE -->
                <p:commandButton icon="pi pi-trash"
                                 title="Delete"
                                 actionListener="#{adminCDI.delete(evt.eId)}"
                                 update="eventTable msgs"
                                 onclick="return confirm('Delete this event?')"
                                 styleClass="p-button-rounded p-button-sm p-button-danger" />
            </p:column>

        </p:dataTable>

    </h:form>


    <!-- DIALOG -->
    <p:dialog id="eventDialog" header="Event Details" widgetVar="eventDialog"
              modal="true" resizable="false" width="640">

        <h:form id="eventDialogForm" enctype="multipart/form-data">

<!--            <p:messages id="dialogMsgs" showDetail="true" autoUpdate="true" />-->

            <p:panelGrid columns="2" columnClasses="label,value" style="width:100%">

                <h:outputLabel value="Name:" for="name" />
                <p:inputText id="name" value="#{adminCDI.current.eName}" required="true" />

                <h:outputLabel value="Description:" for="desc" />
                <p:inputTextarea id="desc" value="#{adminCDI.current.description}" rows="3" />

                <h:outputLabel value="Event Date:" for="date" />
                <p:datePicker id="date" value="#{adminCDI.current.eventDate}"
                              pattern="yyyy-MM-dd" required="true" />

                <h:outputLabel value="Start Time:" for="start" />
                <p:datePicker id="start" value="#{adminCDI.current.startTime}"
                              timeOnly="true" pattern="HH:mm" required="true" />

                <h:outputLabel value="End Time:" for="end" />
                <p:datePicker id="end" value="#{adminCDI.current.endTime}"
                              timeOnly="true" pattern="HH:mm" />

                <h:outputLabel value="Unit Price:" for="price" />
                <p:inputText id="price" value="#{adminCDI.current.unitPrice}" />

                <h:outputLabel value="Venue ID:" for="venue" />
                <p:inputText id="venue" value="#{adminCDI.venueId}" required="true" />

                <h:outputLabel value="Category ID:" for="category" />
                <p:inputText id="category" value="#{adminCDI.categoryId}" required="true" />

                <h:outputLabel value="Max Capacity:" for="cap" />
                <p:inputText id="cap" value="#{adminCDI.current.maxCapacity}" />

                <h:outputLabel value="Banner Image:" for="banner" />
                <p:fileUpload id="banner" 
                              mode="advanced" 
                              auto="true"
                              fileLimit="1"
                              allowTypes="/(\.|\/)(jpe?g|png|gif)$/i"
                              listener="#{adminCDI.handleFileUpload}"
                              update="dialogMsgs currentImagePanel"
                              skinSimple="true" />

                <!-- Show current/uploaded image -->
                <h:outputLabel value="Current Image:" />
                <h:panelGroup id="currentImagePanel">
                    <h:outputText value="#{adminCDI.current.bannerImg}" 
                                  rendered="#{adminCDI.current.bannerImg != null and adminCDI.current.bannerImg != ''}"
                                  style="display: block; margin-bottom: 10px;" />
                    <p:graphicImage value="/uploads/banners/#{adminCDI.current.bannerImg}" 
                                    width="200" 
                                    rendered="#{adminCDI.current.bannerImg != null and adminCDI.current.bannerImg != ''}"
                                    style="margin-top: 5px;" />
                </h:panelGroup>

                <h:outputLabel value="Status:" for="status" />
                <p:inputText id="status" value="#{adminCDI.current.status}" />

            </p:panelGrid>

            <p:separator style="margin: 15px 0;" />

            <div style="text-align: right;">
                <!-- SAVE -->
                <p:commandButton value="Save"
                                 actionListener="#{adminCDI.save}"
                                 update="eventDialogForm :crudForm:eventTable :crudForm:msgs"
                                 oncomplete="if (!args.validationFailed) PF('eventDialog').hide()" 
                                 process="@form"
                                 style="margin-right: 10px;" />

                <!-- CANCEL -->
                <p:commandButton value="Cancel"
                                 type="button"
                                 onclick="PF('eventDialog').hide()" />
            </div>

        </h:form>

    </p:dialog>

</ui:composition>
