<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <h:head>
        <title> CRUD Management</title>
        <h:outputStylesheet library="css" name="eventease.css"/>
        <style>
            .label-col {
                width: 30%;
                padding: 10px;
                text-align: right;
                vertical-align: middle;
                font-weight: bold;
            }
            .value-col {
                width: 70%;
                padding: 10px;
            }
        </style>
    </h:head>

    <h:body>

        <f:metadata>
            <f:viewAction action="#{genericCrudCDI.init}" />
        </f:metadata>

        <h:form id="mainForm">

            <p:messages id="msgs" showDetail="true" closable="true" />

            <h2 style="margin-bottom: 12px;"> CRUD Management</h2>

            <!-- TABLE SELECTOR DROPDOWN -->
            <p:panelGrid columns="2" style="margin-bottom: 20px;">
                <h:outputLabel value="Select Table:" for="tableDropdown" />
                <p:selectOneMenu id="tableDropdown"
                                 value="#{genericCrudCDI.selectedTable}"
                                 style="width: 300px;">
                    <f:selectItem itemLabel="-- Select a Table --"
                                  itemValue=""
                                  noSelectionOption="true" />
                    <f:selectItems value="#{genericCrudCDI.availableTables.entrySet()}"
                                   var="entry"
                                   itemLabel="#{entry.key}"
                                   itemValue="#{entry.value}" />
                    <p:ajax event="change"
                            listener="#{genericCrudCDI.onTableSelect}"
                            update="dataPanel addButton" />
                </p:selectOneMenu>
            </p:panelGrid>

            <!-- ADD BUTTON -->
            <p:commandButton id="addButton"
                             value="Add New Record"
                             icon="pi pi-plus"
                             styleClass="ui-button-success"
                             actionListener="#{genericCrudCDI.prepareNew}"
                             update=":dialogForm:recordDialogContent"
                             oncomplete="PF('recordDialog').show();"
                             disabled="#{empty genericCrudCDI.selectedTable}"
                             style="margin-bottom: 15px;" />

            <!-- DATA PANEL -->
            <h:panelGroup id="dataPanel">

                <p:panel rendered="#{not empty genericCrudCDI.selectedTable}" style="margin-bottom: 10px;">
                    <strong>Loaded : </strong>
                    Table: #{genericCrudCDI.selectedTable},
                    Records: #{genericCrudCDI.tableData.size()},
                    Columns: #{genericCrudCDI.tableColumns.size()}
                </p:panel>

                <p:dataTable id="dataTable"
                             var="record"
                             value="#{genericCrudCDI.tableData}"
                             paginator="true"
                             rows="10"
                             rendered="#{not empty genericCrudCDI.selectedTable}"
                             style="margin-top:10px;"
                             emptyMessage="No records found">

                    <p:columns value="#{genericCrudCDI.tableColumns}"
                               var="column"
                               headerText="#{genericCrudCDI.getColumnHeader(column)}"
                               sortBy="#{record[column]}">
                        <h:outputText value="#{record[column]}" />
                    </p:columns>

                    <p:column headerText="Actions" style="width:140px; text-align: center;" exportable="false">
                        <p:commandButton icon="pi pi-pencil"
                                         title="Edit"
                                         actionListener="#{genericCrudCDI.prepareEdit(record)}"
                                         update=":dialogForm:recordDialogContent"
                                         oncomplete="PF('recordDialog').show();"
                                         styleClass="ui-button-warning ui-button-rounded"
                                         style="margin-right: 5px;" />

                        <p:commandButton icon="pi pi-trash"
                                         title="Delete"
                                         actionListener="#{genericCrudCDI.delete(record)}"
                                         update=":mainForm:dataTable :mainForm:msgs"
                                         styleClass="ui-button-danger ui-button-rounded">
                            <p:confirm header="Confirmation"
                                       message="Are you sure you want to delete this record?"
                                       icon="pi pi-exclamation-triangle" />
                        </p:commandButton>
                    </p:column>

                </p:dataTable>

                <h:outputText value="Please select a table from the dropdown above to view data."
                              rendered="#{empty genericCrudCDI.selectedTable}"
                              style="display: block; margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 5px; color: #666;" />
            </h:panelGroup>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" />
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" />
            </p:confirmDialog>

        </h:form>

        <!-- SEPARATE FORM FOR DIALOG -->
        <h:form id="dialogForm" enctype="multipart/form-data">
            <p:dialog id="recordDialog"
                      header="#{empty genericCrudCDI.currentRecord[genericCrudCDI.primaryKeyColumn] or genericCrudCDI.currentRecord[genericCrudCDI.primaryKeyColumn] eq '' ? 'Add New' : 'Edit'} Record - #{genericCrudCDI.selectedTable}"
                      widgetVar="recordDialog"
                      modal="true"
                      resizable="false"
                      width="700"
                      showEffect="fade"
                      hideEffect="fade">

                <h:panelGroup id="recordDialogContent">

                    <p:messages id="dialogMsgs" showDetail="true" closable="true" />

                    <p:panelGrid columns="2"
                                 style="width: 100%;"
                                 columnClasses="label-col,value-col"
                                 rendered="#{not empty genericCrudCDI.tableColumns}">

                        <ui:repeat value="#{genericCrudCDI.tableColumns}" var="column">
                            <p:outputLabel value="#{genericCrudCDI.getColumnHeader(column)}:" />

                            <h:panelGroup>
                                <!-- VENUE DROPDOWN (for vId in events table) -->
                                <p:selectOneMenu value="#{genericCrudCDI.currentRecord[column]}"
                                                 style="width: 100%;"
                                                 rendered="#{column eq 'vId' and genericCrudCDI.selectedTable eq 'events'}"
                                                 disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}">
                                    <f:selectItem itemLabel="-- Select Venue --" itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{genericCrudCDI.availableVenues}"
                                                   var="venue"
                                                   itemLabel="#{venue['vName']} (#{venue['vCity']})"
                                                   itemValue="#{venue['vId']}" />
                                </p:selectOneMenu>

                                <!-- CATEGORY DROPDOWN (for cId in events table) -->
                                <p:selectOneMenu value="#{genericCrudCDI.currentRecord[column]}"
                                                 style="width: 100%;"
                                                 rendered="#{column eq 'cId' and genericCrudCDI.selectedTable eq 'events'}"
                                                 disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}">
                                    <f:selectItem itemLabel="-- Select Category --" itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{genericCrudCDI.availableCategories}"
                                                   var="category"
                                                   itemLabel="#{category['cName']}"
                                                   itemValue="#{category['cId']}" />
                                </p:selectOneMenu>

                                <!-- ARTIST DROPDOWN (for aId in socialLinks table) -->
                                <p:selectOneMenu value="#{genericCrudCDI.currentRecord[column]}"
                                                 style="width: 100%;"
                                                 rendered="#{column eq 'aId' and genericCrudCDI.selectedTable eq 'socialLinks'}"
                                                 disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}">
                                    <f:selectItem itemLabel="-- Select Artist --" itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{genericCrudCDI.availableArtists}"
                                                   var="artist"
                                                   itemLabel="#{artist['aName']}"
                                                   itemValue="#{artist['aId']}" />
                                </p:selectOneMenu>

                                <!-- Date fields -->
                                <p:inputText value="#{genericCrudCDI.currentRecord[column]}"
                                             style="width: 100%;"
                                             type="date"
                                             rendered="#{column eq 'eventDate' or column eq 'validFrom' or column eq 'validTo' or column eq 'reviewDate'}"
                                             readonly="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}"
                                             disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}" />

                                <!-- Time fields -->
                                <p:inputText value="#{genericCrudCDI.currentRecord[column]}"
                                             style="width: 100%;"
                                             type="time"
                                             rendered="#{column eq 'startTime' or column eq 'endTime'}"
                                             readonly="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}"
                                             disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}" />

                                <!-- Number fields -->
                                <p:inputText value="#{genericCrudCDI.currentRecord[column]}"
                                             style="width: 100%;"
                                             type="number"
                                             rendered="#{column eq 'unitPrice' or column eq 'maxCapacity' or column eq 'vCapacity' or column eq 'discountValue' or column eq 'maxUses' or column eq 'rating'}"
                                             readonly="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}"
                                             disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}" />

                                <!-- Textarea for long text -->
                                <p:inputTextarea value="#{genericCrudCDI.currentRecord[column]}"
                                                 style="width: 100%;"
                                                 rows="3"
                                                 rendered="#{column eq 'description' or column eq 'cDescription' or column eq 'aBio' or column eq 'comment'}"
                                                 readonly="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}"
                                                 disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}" />

                                <!-- Image Upload fields -->
                                <h:panelGroup rendered="#{column eq 'bannerImg' or column eq 'cImg' or column eq 'aImgUrl' or column eq 'imgUrl'}">
                                    <div style="margin-bottom: 10px;">
                                        <p:fileUpload mode="simple" 
                                                      skinSimple="true"
                                                      label="Choose Image"
                                                      value="#{genericCrudCDI.uploadedFile}"
                                                      style="width: 100%;">
                                            <f:attribute name="fieldName" value="#{column}" />
                                        </p:fileUpload>
                                        <p:commandButton value="Upload" 
                                                         icon="pi pi-upload"
                                                         ajax="true"
                                                         process="@form"
                                                         update=":dialogForm:recordDialogContent :dialogForm:dialogMsgs"
                                                         actionListener="#{genericCrudCDI.processUpload(column)}"
                                                         style="margin-top: 5px;"
                                                         styleClass="ui-button-success ui-button-sm" />
                                    </div>
                                    <h:outputText value="âœ“ Uploaded: #{genericCrudCDI.currentRecord[column]}" 
                                                  style="font-size: 0.9em; color: #28a745; display: block; margin-top: 5px;"
                                                  rendered="#{not empty genericCrudCDI.currentRecord[column]}" />
                                </h:panelGroup>

                                <!-- Regular URL fields (for links, not images) -->
                                <p:inputText value="#{genericCrudCDI.currentRecord[column]}"
                                             style="width: 100%;"
                                             type="url"
                                             rendered="#{column eq 'link'}"
                                             readonly="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}"
                                             disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}" />

                                <!-- Skip derived/display-only fields from input -->
                                <h:outputText value="#{genericCrudCDI.currentRecord[column]}"
                                              style="width: 100%; display: block; padding: 8px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px;"
                                              rendered="#{(column eq 'vName' and genericCrudCDI.selectedTable eq 'events') 
                                                          or (column eq 'cName' and genericCrudCDI.selectedTable eq 'events')
                                                          or (column eq 'aName' and genericCrudCDI.selectedTable eq 'socialLinks')}" />

                                <!-- Default text input for all other fields -->
                                <p:inputText value="#{genericCrudCDI.currentRecord[column]}"
                                             style="width: 100%;"
                                             rendered="#{column ne 'eventDate' and column ne 'validFrom' and column ne 'validTo' and column ne 'reviewDate' 
                                                         and column ne 'startTime' and column ne 'endTime'
                                                         and column ne 'unitPrice' and column ne 'maxCapacity' and column ne 'vCapacity' and column ne 'discountValue' and column ne 'maxUses' and column ne 'rating'
                                                         and column ne 'description' and column ne 'cDescription' and column ne 'aBio' and column ne 'comment'
                                                         and column ne 'bannerImg' and column ne 'cImg' and column ne 'aImgUrl' and column ne 'imgUrl' and column ne 'link'
                                                         and not (column eq 'vId' and genericCrudCDI.selectedTable eq 'events')
                                                         and not (column eq 'cId' and genericCrudCDI.selectedTable eq 'events')
                                                         and not (column eq 'aId' and genericCrudCDI.selectedTable eq 'socialLinks')
                                                         and not (column eq 'vName' and genericCrudCDI.selectedTable eq 'events')
                                                         and not (column eq 'cName' and genericCrudCDI.selectedTable eq 'events')
                                                         and not (column eq 'aName' and genericCrudCDI.selectedTable eq 'socialLinks')}"
                                             readonly="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}"
                                             disabled="#{column eq genericCrudCDI.primaryKeyColumn and not empty genericCrudCDI.currentRecord[column]}" />
                            </h:panelGroup>
                        </ui:repeat>

                    </p:panelGrid>

                    <p:separator style="margin: 15px 0;" />

                    <div style="text-align: right;">
                        <p:commandButton value="Save"
                                         icon="pi pi-check"
                                         actionListener="#{genericCrudCDI.save}"
                                         update=":dialogForm:dialogMsgs :dialogForm:recordDialogContent :mainForm:dataPanel :mainForm:msgs"
                                         oncomplete="if (args &amp;&amp; !args.validationFailed) PF('recordDialog').hide();"
                                         styleClass="ui-button-success"
                                         style="margin-right: 10px;" />

                        <p:commandButton value="Cancel"
                                         icon="pi pi-times"
                                         type="button"
                                         onclick="PF('recordDialog').hide();"
                                         styleClass="ui-button-secondary" />
                    </div>

                </h:panelGroup>

            </p:dialog>
        </h:form>

    </h:body>
</html>